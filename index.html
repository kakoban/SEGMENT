<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ØªÙˆÙ„ÛŒØ¯ Ø³Ú¯Ù…Ù†Øª - Ù†Ø³Ø®Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #EBF4FF 0%, #E0E7FF 100%); min-height: 100vh; padding: 1rem;}
        .container {max-width: 1200px; margin: 0 auto;}
        .header {background: linear-gradient(to left, #DC2626 0%, #B91C1C 100%); color: white; border-radius: 1rem 1rem 0 0; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.15);}
        .header-content {display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;}
        .header-title {display: flex; align-items: center; gap: 0.75rem;}
        .header h1 {font-size: 1.5rem; font-weight: bold;}
        .header p {color: #FEE2E2; font-size: 0.875rem; margin-top: 0.25rem;}
        .badge {background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;}
        .badge:hover {background: rgba(255,255,255,0.3);}
        .badge.success {background: rgba(16, 185, 129, 0.3);}
        .icon {width: 2rem; height: 2rem; stroke: currentColor; stroke-width: 2; fill: none;}
        .form-container {background: white; border-radius: 0 0 1rem 1rem; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);}
        .section {margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #E5E7EB;}
        .section:last-of-type {border-bottom: none;}
        .section-title {font-size: 1.125rem; font-weight: bold; color: #1F2937; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; justify-content: space-between;}
        .grid {display: grid; gap: 1rem; grid-template-columns: 1fr;}
        @media (min-width: 768px) {.grid {grid-template-columns: repeat(2, 1fr);} .form-container {padding: 2.5rem;}}
        .form-group {display: flex; flex-direction: column;}
        label {font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;}
        input, textarea, select {padding: 0.75rem 1rem; border: 2px solid #D1D5DB; border-radius: 0.5rem; font-size: 1rem; transition: all 0.2s; font-family: inherit;}
        input:focus, textarea:focus, select:focus {outline: none; border-color: #6366F1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);}
        textarea {resize: vertical; min-height: 100px;}
        .info-box {background: #F0F9FF; border: 2px solid #3B82F6; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;}
        .info-box.warning {background: #FEF3C7; border-color: #F59E0B;}
        .info-box.success {background: #D1FAE5; border-color: #10B981;}
        .info-box h3 {font-size: 0.875rem; font-weight: bold; color: #1E40AF; margin-bottom: 0.5rem;}
        .info-box.warning h3 {color: #92400E;}
        .info-box.success h3 {color: #065F46;}
        .info-table {width: 100%; border-collapse: collapse; font-size: 0.875rem;}
        .info-table td {padding: 0.5rem; border-bottom: 1px solid #BFDBFE;}
        .info-table td:first-child {font-weight: 600; color: #1E40AF;}
        .info-table tr:last-child td {border-bottom: none;}
        .stock-display {display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; margin-top: 1rem;}
        .stock-item {background: #F9FAFB; border: 2px solid #E5E7EB; border-radius: 0.5rem; padding: 0.75rem; text-align: center; transition: all 0.3s;}
        .stock-item-title {font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem;}
        .stock-item-value {font-size: 1.25rem; font-weight: bold; color: #1F2937; margin: 0.25rem 0;}
        .stock-item-detail {font-size: 0.7rem; color: #9CA3AF;}
        .stock-item.low {background: #FEF2F2; border-color: #FCA5A5;}
        .stock-item.low .stock-item-value {color: #DC2626;}
        .stock-item.warning {background: #FEF3C7; border-color: #FCD34D;}
        .stock-item.warning .stock-item-value {color: #D97706;}
        .button-group {display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-top: 2rem;}
        button {padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
        button:hover:not(:disabled) {transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15);}
        button:disabled {opacity: 0.6; cursor: not-allowed; transform: none;}
        .btn-primary {background: linear-gradient(to left, #6366F1 0%, #4F46E5 100%); color: white;}
        .btn-save {background: linear-gradient(to left, #10B981 0%, #059669 100%); color: white;}
        .btn-danger {background: linear-gradient(to left, #EF4444 0%, #DC2626 100%); color: white;}
        .btn-secondary {background: linear-gradient(to left, #8B5CF6 0%, #7C3AED 100%); color: white;}
        .btn-sm {padding: 0.5rem 1rem; font-size: 0.8rem;}
        .modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem;}
        .modal.show {display: flex;}
        .modal-content {background: white; border-radius: 1rem; padding: 2rem; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;}
        .modal-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #E5E7EB;}
        .modal-header h2 {font-size: 1.25rem; color: #1F2937;}
        .modal-close {background: #EF4444; color: white; border: none; border-radius: 0.375rem; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; font-weight: bold;}
        .material-item {background: #F9FAFB; border: 2px solid #E5E7EB; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;}
        .material-info {flex: 1;}
        .material-name {font-weight: bold; color: #1F2937; margin-bottom: 0.25rem;}
        .material-details {font-size: 0.875rem; color: #6B7280;}
        .material-actions {display: flex; gap: 0.5rem;}
        .alert {position: fixed; top: 2rem; left: 50%; transform: translateX(-50%) translateY(-100px); background: #10B981; color: white; padding: 1rem 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); opacity: 0; transition: all 0.3s; z-index: 1000; font-weight: bold;}
        .alert.show {transform: translateX(-50%) translateY(0); opacity: 1;}
        .alert.error {background: #EF4444;}
        .calendar {position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.5rem; background: white; border: 2px solid #6366F1; border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.25); z-index: 100; padding: 1.25rem; min-width: 320px;}
        .calendar-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; padding-bottom: 1rem; border-bottom: 2px solid #E5E7EB;}
        .calendar-header button {width: 2.5rem; height: 2.5rem; background: linear-gradient(135deg, #6366F1, #4F46E5); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1rem; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.2s;}
        .calendar-header button:hover {background: linear-gradient(135deg, #4F46E5, #4338CA); transform: scale(1.05); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);}
        .calendar-title {font-weight: bold; color: #1F2937; font-size: 1.1rem; text-align: center;}
        .calendar-weekdays {display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;}
        .calendar-weekday {text-align: center; font-size: 0.8rem; font-weight: bold; color: #6B7280; padding: 0.5rem; background: #F9FAFB; border-radius: 0.375rem;}
        .calendar-days {display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;}
        .calendar-day {aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; border: 2px solid transparent; background: #F9FAFB; font-weight: 500;}
        .calendar-day:hover {background: #EEF2FF; border-color: #6366F1; transform: scale(1.05);}
        .calendar-day.selected {background: linear-gradient(135deg, #6366F1, #4F46E5); color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);}
        .calendar-day.today {border: 2px solid #10B981; background: #D1FAE5; font-weight: bold; color: #065F46;}
        .calendar-day.other-month {color: #D1D5DB; background: transparent;}
    </style>
</head>
<body>
    <div class="alert" id="alert">Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚ âœ“</div>

    <!-- Materials Modal -->
    <div class="modal" id="materialsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“¦ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</h2>
                <button class="modal-close" onclick="closeMaterialsModal()">Ø¨Ø³ØªÙ†</button>
            </div>

            <button class="btn-primary btn-sm" onclick="showAddMaterialForm()" style="margin-bottom: 1rem; width: 100%;">
                â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯
            </button>

            <div id="addMaterialForm" style="display: none; background: #F0F9FF; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Ù…Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯</h3>
                <div class="grid">
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ù…Ø§Ø¯Ù‡</label>
                        <input type="text" id="newMaterialName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø³ÛŒÙ…Ø§Ù† Ù¾Ø±ØªÙ„Ù†Ø¯">
                    </div>
                    <div class="form-group">
                        <label>ÙˆØ§Ø­Ø¯</label>
                        <input type="text" id="newMaterialUnit" placeholder="Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù… / Ù„ÛŒØªØ± / ØªÙ†">
                    </div>
                    <div class="form-group">
                        <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø¨Ù†Ø§</label>
                        <input type="number" id="newMaterialInitial" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Ù…ØµØ±Ù Ø¯Ø± Ø±ÛŒÙ†Ú¯</label>
                        <input type="number" id="newMaterialConsumption" placeholder="0">
                    </div>
                </div>
                <div class="button-group" style="margin-top: 0.75rem;">
                    <button class="btn-save" onclick="addMaterial()">âœ“ Ø°Ø®ÛŒØ±Ù‡</button>
                    <button class="btn-danger" onclick="hideAddMaterialForm()">âœ• Ù„ØºÙˆ</button>
                </div>
            </div>

            <div id="materialsList"></div>
        </div>
    </div>

    <!-- Edit Material Modal -->
    <div class="modal" id="editMaterialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø§Ø¯Ù‡</h2>
                <button class="modal-close" onclick="closeEditMaterialModal()">Ø¨Ø³ØªÙ†</button>
            </div>
            <input type="hidden" id="editMaterialKey">
            <div class="grid">
                <div class="form-group">
                    <label>Ù†Ø§Ù… Ù…Ø§Ø¯Ù‡</label>
                    <input type="text" id="editMaterialName">
                </div>
                <div class="form-group">
                    <label>ÙˆØ§Ø­Ø¯</label>
                    <input type="text" id="editMaterialUnit">
                </div>
                <div class="form-group">
                    <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø¨Ù†Ø§</label>
                    <input type="number" id="editMaterialInitial">
                </div>
                <div class="form-group">
                    <label>Ù…ØµØ±Ù Ø¯Ø± Ø±ÛŒÙ†Ú¯</label>
                    <input type="number" id="editMaterialConsumption">
                </div>
            </div>
            <button class="btn-save" onclick="saveEditMaterial()" style="width: 100%; margin-top: 1rem;">
                âœ“ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
            </button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <div>
                        <h1>Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ØªÙˆÙ„ÛŒØ¯ Ø³Ú¯Ù…Ù†Øª</h1>
                        <p>ğŸ”´ Ù¾Ø±ÙˆÚ˜Ù‡ Ø®Ø· Û±Û° Ù…ØªØ±Ùˆ ØªÙ‡Ø±Ø§Ù† - Ù†Ø³Ø®Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</p>
                    </div>
                </div>
                <div class="badge success">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù† ÙØ¹Ø§Ù„</div>
            </div>
        </div>

        <div class="form-container">
            <div class="info-box success">
                <h3>âœ“ Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡</h3>
                <p style="font-size: 0.875rem; color: #065F46;" id="lastSaveInfo">Ù‡Ù†ÙˆØ² Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡</p>
            </div>

            <!-- ØªØ§Ø±ÛŒØ® -->
            <div class="section">
                <h2 class="section-title">
                    <span>ğŸ“… ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´</span>
                </h2>
                <div class="grid">
                    <div class="form-group">
                        <label>ØªØ§Ø±ÛŒØ® (Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</label>
                        <div style="position: relative;">
                            <input type="text" id="reportDate" value="1404/08/18" readonly style="cursor: pointer; background: white;">
                            <div id="calendar" class="calendar" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ø±ÙˆØ²</label>
                        <input type="text" id="dayName" value="Ø´Ù†Ø¨Ù‡" readonly style="background: #F3F4F6;">
                    </div>
                </div>
            </div>

            <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ„ÛŒØ¯ -->
            <div class="section">
                <h2 class="section-title">
                    <span>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ„ÛŒØ¯</span>
                </h2>
                <div class="grid">
                    <div class="form-group">
                        <label>ØªÙˆÙ„ÛŒØ¯ Ø±ÙˆØ² (Ø±ÛŒÙ†Ú¯)</label>
                        <input type="number" id="ringsProduced" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø³Ø¨Ø¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡</label>
                        <input type="number" id="basketsProduced" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªÙˆÙ„ÛŒØ¯ Ù…Ø§Ù‡ (Ø±ÛŒÙ†Ú¯)</label>
                        <input type="number" id="monthlyProduction" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªÙˆÙ„ÛŒØ¯ Ø³Ø§Ù„ Û±Û´Û°Û´</label>
                        <input type="number" id="yearlyProduction" value="0">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>ØªÙˆÙ„ÛŒØ¯ ØªØ¬Ù…Ø¹ÛŒ Ú©Ù„</label>
                        <input type="number" id="totalProduction" value="0">
                    </div>
                </div>
            </div>

            <!-- Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…ÙˆØ§Ø¯ -->
            <div class="section">
                <h2 class="section-title">
                    <span>ğŸ“¦ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</span>
                    <button class="btn-secondary btn-sm" onclick="openMaterialsModal()">
                        âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ§Ø¯
                    </button>
                </h2>

                <div id="materialRatesDisplay" class="info-box">
                    <h3>ğŸ“Œ Ù…ØµØ±Ù Ù…ÙˆØ§Ø¯ Ø¯Ø± Ù‡Ø± Ø±ÛŒÙ†Ú¯</h3>
                    <table class="info-table" id="ratesTable"></table>
                </div>

                <div class="grid" id="stockInputs"></div>

                <h3 style="margin-top: 1.5rem; margin-bottom: 0.75rem; font-size: 1rem; color: #1F2937;">ğŸ’¡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¸Ø±ÙÛŒØª</h3>
                <div class="stock-display" id="stockDisplay"></div>
            </div>

            <!-- Ù…Ø´Ú©Ù„Ø§Øª -->
            <div class="section">
                <h2 class="section-title">âš ï¸ Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ù…ÙˆØ§Ù†Ø¹</h2>
                <textarea id="issues" placeholder="Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
            </div>

            <!-- Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª -->
            <div class="section">
                <h2 class="section-title">ğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª</h2>
                <textarea id="suggestions" placeholder="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
            </div>

            <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
            <div class="button-group">
                <button class="btn-save" onclick="saveData()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn-primary" onclick="exportJSON()">ğŸ“¥ ØµØ§Ø¯Ø±Ø§Øª JSON</button>
                <button class="btn-primary" onclick="copyReport()">ğŸ“‹ Ú©Ù¾ÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
            </div>
        </div>
    </div>

    <script>
        let materials = {
            rebar8: {name: 'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Û¸', unit: 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', initialStock: 0, ringConsumption: 736},
            rebar12: {name: 'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Û±Û²', unit: 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', initialStock: 0, ringConsumption: 758},
            rebar20: {name: 'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Û²Û°', unit: 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', initialStock: 0, ringConsumption: 250},
            superplasticizer: {name: 'ÙÙˆÙ‚ Ø±ÙˆØ§Ù†â€ŒÚ©Ù†Ù†Ø¯Ù‡', unit: 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', initialStock: 0, ringConsumption: 45}
        };

        let materialStocks = {};

        const persianMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
        const persianDays = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡'];
        let currentJalaliDate, selectedJalaliDate, calendarDisplayMonth, calendarDisplayYear;

        function toPersianNumber(num) {
            const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            return String(num).replace(/\d/g, x => persianDigits[x]);
        }

        function toJalali(gy, gm, gd) {
            const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            let jy = (gy <= 1600) ? 0 : 979;
            gy -= (gy <= 1600) ? 621 : 1600;
            let gy2 = (gm > 2) ? (gy + 1) : gy;
            let days = (365 * gy) + (Math.floor((gy2 + 3) / 4)) - (Math.floor((gy2 + 99) / 100)) + (Math.floor((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
            jy += 33 * Math.floor(days / 12053);
            days %= 12053;
            jy += 4 * Math.floor(days / 1461);
            days %= 1461;
            if (days > 365) {
                jy += Math.floor((days - 1) / 365);
                days = (days - 1) % 365;
            }
            let jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
            let jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
            return {year: jy, month: jm, day: jd};
        }

        function toGregorian(jy, jm, jd) {
            let gy = (jy <= 979) ? 621 : 1600;
            jy -= (jy <= 979) ? 0 : 979;
            let days = (365 * jy) + (Math.floor(jy / 33) * 8) + Math.floor(((jy % 33) + 3) / 4) + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
            gy += 400 * Math.floor(days / 146097);
            days %= 146097;
            let leap = true;
            if (days >= 36525) {
                days--;
                gy += 100 * Math.floor(days / 36524);
                days %= 36524;
                if (days >= 365) days++;
                else leap = false;
            }
            gy += 4 * Math.floor(days / 1461);
            days %= 1461;
            if (days >= 366) {
                leap = false;
                days--;
                gy += Math.floor(days / 365);
                days %= 365;
            }
            let gd = days + 1;
            let sal_a = [0, 31, ((leap && gy >= 1600) || (!leap && gy < 1600)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            let gm = 0;
            for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm];
            return {gy: gy, gm: gm, gd: gd};
        }

        function initCalendar() {
            const now = new Date();
            currentJalaliDate = toJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
            selectedJalaliDate = {...currentJalaliDate};
            calendarDisplayMonth = currentJalaliDate.month;
            calendarDisplayYear = currentJalaliDate.year;
            updateDateDisplay();
            
            document.getElementById('reportDate').addEventListener('click', toggleCalendar);
        }

        function toggleCalendar() {
            const calendar = document.getElementById('calendar');
            if (calendar.style.display === 'none') {
                calendar.style.display = 'block';
                renderCalendar();
            } else {
                calendar.style.display = 'none';
            }
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            let html = '<div class="calendar-header">';
            html += '<button onclick="previousMonth(event)" title="Ù…Ø§Ù‡ Ù‚Ø¨Ù„">â—€</button>';
            html += '<div class="calendar-title">' + persianMonths[calendarDisplayMonth - 1] + ' ' + toPersianNumber(calendarDisplayYear) + '</div>';
            html += '<button onclick="nextMonth(event)" title="Ù…Ø§Ù‡ Ø¨Ø¹Ø¯">â–¶</button></div>';
            
            html += '<div class="calendar-weekdays">';
            ['Ø´', 'ÛŒ', 'Ø¯', 'Ø³', 'Ú†', 'Ù¾', 'Ø¬'].forEach(day => {
                html += '<div class="calendar-weekday">' + day + '</div>';
            });
            html += '</div><div class="calendar-days">';
            
            const firstDayOfMonth = toGregorian(calendarDisplayYear, calendarDisplayMonth, 1);
            const firstDate = new Date(firstDayOfMonth.gy, firstDayOfMonth.gm - 1, firstDayOfMonth.gd);
            const firstDayOfWeek = (firstDate.getDay() + 1) % 7;
            const daysInMonth = calendarDisplayMonth <= 6 ? 31 : (calendarDisplayMonth <= 11 ? 30 : 29);
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isSelected = day === selectedJalaliDate.day && 
                                 calendarDisplayMonth === selectedJalaliDate.month && 
                                 calendarDisplayYear === selectedJalaliDate.year;
                const isToday = day === currentJalaliDate.day && 
                               calendarDisplayMonth === currentJalaliDate.month && 
                               calendarDisplayYear === currentJalaliDate.year;
                
                let classes = 'calendar-day';
                if (isSelected) classes += ' selected';
                if (isToday) classes += ' today';
                
                html += '<div class="' + classes + '" onclick="selectDate(' + day + ')">' + 
                        toPersianNumber(day) + '</div>';
            }
            
            html += '</div>';
            calendar.innerHTML = html;
        }

        function selectDate(day) {
            selectedJalaliDate = {year: calendarDisplayYear, month: calendarDisplayMonth, day: day};
            updateDateDisplay();
            toggleCalendar();
        }

        function previousMonth(event) {
            event.stopPropagation();
            calendarDisplayMonth--;
            if (calendarDisplayMonth < 1) {
                calendarDisplayMonth = 12;
                calendarDisplayYear--;
            }
            renderCalendar();
        }

        function nextMonth(event) {
            event.stopPropagation();
            calendarDisplayMonth++;
            if (calendarDisplayMonth > 12) {
                calendarDisplayMonth = 1;
                calendarDisplayYear++;
            }
            renderCalendar();
        }

        function updateDateDisplay() {
            const jalali = selectedJalaliDate;
            const gregorian = toGregorian(jalali.year, jalali.month, jalali.day);
            const date = new Date(gregorian.gy, gregorian.gm - 1, gregorian.gd);
            const dayOfWeek = date.getDay();
            
            document.getElementById('reportDate').value = 
                toPersianNumber(jalali.year) + '/' + 
                toPersianNumber(String(jalali.month).padStart(2, '0')) + '/' + 
                toPersianNumber(String(jalali.day).padStart(2, '0'));
            
            document.getElementById('dayName').value = persianDays[dayOfWeek];
        }

        function init() {
            initCalendar();
            loadData();
            renderMaterialInputs();
            renderMaterialRates();
            calculateCapacity();
            
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', () => {
                    calculateCapacity();
                });
            });
        }

        function renderMaterialRates() {
            const table = document.getElementById('ratesTable');
            let html = '';
            Object.entries(materials).forEach(([key, mat]) => {
                html += '<tr>';
                html += '<td>' + mat.name + '</td>';
                html += '<td>' + toPersianNumber(mat.ringConsumption) + ' ' + mat.unit + '</td>';
                html += '</tr>';
            });
            table.innerHTML = html;
        }

        function renderMaterialInputs() {
            const container = document.getElementById('stockInputs');
            let html = '';
            Object.entries(materials).forEach(([key, mat]) => {
                html += '<div class="form-group">';
                html += '<label>' + mat.name + ' (' + mat.unit + ')</label>';
                html += '<input type="number" id="stock_' + key + '" value="' + (materialStocks[key] || 0) + '" placeholder="0">';
                html += '</div>';
            });
            container.innerHTML = html;
            
            // Add event listeners
            Object.keys(materials).forEach(key => {
                const input = document.getElementById('stock_' + key);
                if (input) {
                    input.addEventListener('input', () => {
                        materialStocks[key] = parseFloat(input.value) || 0;
                        calculateCapacity();
                    });
                }
            });
        }

        function calculateCapacity() {
            const ringsProduced = parseFloat(document.getElementById('ringsProduced').value) || 0;
            const display = document.getElementById('stockDisplay');
            
            let html = '';
            Object.entries(materials).forEach(([key, mat]) => {
                const stock = materialStocks[key] || 0;
                const used = ringsProduced * mat.ringConsumption;
                const remaining = Math.max(0, stock - used);
                const capacity = Math.floor(remaining / mat.ringConsumption);
                
                const status = capacity < 5 ? 'low' : capacity < 10 ? 'warning' : '';
                
                html += '<div class="stock-item ' + status + '">';
                html += '<div class="stock-item-title">' + mat.name + '</div>';
                html += '<div class="stock-item-value">' + toPersianNumber(capacity) + ' Ø±ÛŒÙ†Ú¯</div>';
                html += '<div class="stock-item-detail">Ù…ØµØ±Ù: ' + toPersianNumber(Math.round(used)) + ' ' + mat.unit + '</div>';
                html += '<div class="stock-item-detail">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ' + toPersianNumber(Math.round(remaining)) + ' ' + mat.unit + '</div>';
                html += '</div>';
            });
            
            display.innerHTML = html;
        }

        function openMaterialsModal() {
            renderMaterialsList();
            document.getElementById('materialsModal').classList.add('show');
        }

        function closeMaterialsModal() {
            document.getElementById('materialsModal').classList.remove('show');
            hideAddMaterialForm();
        }

        function showAddMaterialForm() {
            document.getElementById('addMaterialForm').style.display = 'block';
        }

        function hideAddMaterialForm() {
            document.getElementById('addMaterialForm').style.display = 'none';
            document.getElementById('newMaterialName').value = '';
            document.getElementById('newMaterialUnit').value = '';
            document.getElementById('newMaterialInitial').value = '';
            document.getElementById('newMaterialConsumption').value = '';
        }

        function addMaterial() {
            const name = document.getElementById('newMaterialName').value.trim();
            const unit = document.getElementById('newMaterialUnit').value.trim();
            const initial = parseFloat(document.getElementById('newMaterialInitial').value) || 0;
            const consumption = parseFloat(document.getElementById('newMaterialConsumption').value) || 0;
            
            if (!name || !unit) {
                showAlert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ ÙˆØ§Ø­Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            const key = 'mat_' + Date.now();
            materials[key] = {
                name: name,
                unit: unit,
                initialStock: initial,
                ringConsumption: consumption
            };
            
            materialStocks[key] = initial;
            
            hideAddMaterialForm();
            renderMaterialsList();
            renderMaterialInputs();
            renderMaterialRates();
            calculateCapacity();
            showAlert('Ù…Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
        }

        function renderMaterialsList() {
            const container = document.getElementById('materialsList');
            let html = '';
            
            Object.entries(materials).forEach(([key, mat]) => {
                html += '<div class="material-item">';
                html += '<div class="material-info">';
                html += '<div class="material-name">' + mat.name + '</div>';
                html += '<div class="material-details">';
                html += 'ÙˆØ§Ø­Ø¯: ' + mat.unit + ' | ';
                html += 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø¨Ù†Ø§: ' + toPersianNumber(mat.initialStock) + ' | ';
                html += 'Ù…ØµØ±Ù: ' + toPersianNumber(mat.ringConsumption) + ' Ø¯Ø± Ø±ÛŒÙ†Ú¯';
                html += '</div>';
                html += '</div>';
                html += '<div class="material-actions">';
                html += '<button class="btn-primary btn-sm" onclick="editMaterial(\'' + key + '\')">âœï¸</button>';
                html += '<button class="btn-danger btn-sm" onclick="deleteMaterial(\'' + key + '\')">ğŸ—‘ï¸</button>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function editMaterial(key) {
            const mat = materials[key];
            document.getElementById('editMaterialKey').value = key;
            document.getElementById('editMaterialName').value = mat.name;
            document.getElementById('editMaterialUnit').value = mat.unit;
            document.getElementById('editMaterialInitial').value = mat.initialStock;
            document.getElementById('editMaterialConsumption').value = mat.ringConsumption;
            document.getElementById('editMaterialModal').classList.add('show');
        }

        function closeEditMaterialModal() {
            document.getElementById('editMaterialModal').classList.remove('show');
        }

        function saveEditMaterial() {
            const key = document.getElementById('editMaterialKey').value;
            const name = document.getElementById('editMaterialName').value.trim();
            const unit = document.getElementById('editMaterialUnit').value.trim();
            const initial = parseFloat(document.getElementById('editMaterialInitial').value) || 0;
            const consumption = parseFloat(document.getElementById('editMaterialConsumption').value) || 0;
            
            if (!name || !unit) {
                showAlert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ ÙˆØ§Ø­Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            materials[key] = {
                name: name,
                unit: unit,
                initialStock: initial,
                ringConsumption: consumption
            };
            
            closeEditMaterialModal();
            renderMaterialsList();
            renderMaterialInputs();
            renderMaterialRates();
            calculateCapacity();
            showAlert('ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
        }

        function deleteMaterial(key) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø§Ø¯Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
            
            delete materials[key];
            delete materialStocks[key];
            
            renderMaterialsList();
            renderMaterialInputs();
            renderMaterialRates();
            calculateCapacity();
            showAlert('Ù…Ø§Ø¯Ù‡ Ø­Ø°Ù Ø´Ø¯', 'success');
        }

        function saveData() {
            const data = {
                lastUpdate: new Date().toISOString(),
                date: document.getElementById('reportDate').value,
                dayName: document.getElementById('dayName').value,
                production: {
                    rings: document.getElementById('ringsProduced').value,
                    baskets: document.getElementById('basketsProduced').value,
                    monthly: document.getElementById('monthlyProduction').value,
                    yearly: document.getElementById('yearlyProduction').value,
                    total: document.getElementById('totalProduction').value
                },
                materials: materials,
                stocks: materialStocks,
                issues: document.getElementById('issues').value,
                suggestions: document.getElementById('suggestions').value
            };
            
            localStorage.setItem('segmentData', JSON.stringify(data));
            document.getElementById('lastSaveInfo').textContent = 'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ø¯Ø± ' + new Date().toLocaleTimeString('fa-IR');
            showAlert('âœ“ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
        }

        function loadData() {
            const saved = localStorage.getItem('segmentData');
            if (!saved) return;
            
            try {
                const data = JSON.parse(saved);
                
                if (data.date) document.getElementById('reportDate').value = data.date;
                if (data.dayName) document.getElementById('dayName').value = data.dayName;
                
                if (data.production) {
                    document.getElementById('ringsProduced').value = data.production.rings || 0;
                    document.getElementById('basketsProduced').value = data.production.baskets || 0;
                    document.getElementById('monthlyProduction').value = data.production.monthly || 0;
                    document.getElementById('yearlyProduction').value = data.production.yearly || 0;
                    document.getElementById('totalProduction').value = data.production.total || 0;
                }
                
                if (data.materials) materials = data.materials;
                if (data.stocks) materialStocks = data.stocks;
                if (data.issues) document.getElementById('issues').value = data.issues;
                if (data.suggestions) document.getElementById('suggestions').value = data.suggestions;
                
                if (data.lastUpdate) {
                    document.getElementById('lastSaveInfo').textContent = 
                        'Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡: ' + new Date(data.lastUpdate).toLocaleTimeString('fa-IR');
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function exportJSON() {
            const data = {
                exportDate: new Date().toISOString(),
                date: document.getElementById('reportDate').value,
                production: {
                    rings: document.getElementById('ringsProduced').value,
                    baskets: document.getElementById('basketsProduced').value,
                    monthly: document.getElementById('monthlyProduction').value,
                    yearly: document.getElementById('yearlyProduction').value,
                    total: document.getElementById('totalProduction').value
                },
                materials: materials,
                stocks: materialStocks,
                issues: document.getElementById('issues').value,
                suggestions: document.getElementById('suggestions').value
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'segment-data-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            showAlert('âœ“ ÙØ§ÛŒÙ„ JSON Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
        }

        function copyReport() {
            const date = document.getElementById('reportDate').value;
            const day = document.getElementById('dayName').value;
            const rings = document.getElementById('ringsProduced').value || 'Û°';
            
            let report = 'ğŸ”´ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ØªÙˆÙ„ÛŒØ¯ Ø³Ú¯Ù…Ù†Øª\n';
            report += 'Ù¾Ø±ÙˆÚ˜Ù‡ Ø®Ø· Û±Û° Ù…ØªØ±Ùˆ ØªÙ‡Ø±Ø§Ù†\n';
            report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            report += 'ğŸ“… ØªØ§Ø±ÛŒØ®: ' + date + ' (' + day + ')\n\n';
            report += 'ğŸ“Š ØªÙˆÙ„ÛŒØ¯ Ø±ÙˆØ²: ' + toPersianNumber(rings) + ' Ø±ÛŒÙ†Ú¯\n\n';
            report += 'ğŸ“¦ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…ÙˆØ§Ø¯:\n';
            
            Object.entries(materials).forEach(([key, mat]) => {
                const stock = materialStocks[key] || 0;
                const ringsProduced = parseFloat(document.getElementById('ringsProduced').value) || 0;
                const used = ringsProduced * mat.ringConsumption;
                const remaining = Math.max(0, stock - used);
                const capacity = Math.floor(remaining / mat.ringConsumption);
                
                report += 'â–«ï¸ ' + mat.name + ':\n';
                report += '   â€¢ Ù…ØµØ±Ù Ø±ÙˆØ²: ' + toPersianNumber(Math.round(used)) + ' ' + mat.unit + '\n';
                report += '   â€¢ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ' + toPersianNumber(Math.round(remaining)) + ' ' + mat.unit + '\n';
                report += '   â€¢ Ø¸Ø±ÙÛŒØª: ' + toPersianNumber(capacity) + ' Ø±ÛŒÙ†Ú¯\n\n';
            });
            
            navigator.clipboard.writeText(report).then(() => {
                showAlert('âœ“ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
            });
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert ' + type;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        document.addEventListener('click', function(e) {
            const modals = ['materialsModal', 'editMaterialModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
            
            const calendar = document.getElementById('calendar');
            const dateInput = document.getElementById('reportDate');
            if (calendar && !calendar.contains(e.target) && e.target !== dateInput) {
                calendar.style.display = 'none';
            }
        });

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
