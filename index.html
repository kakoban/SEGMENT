<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø³Ú¯Ù…Ù†Øª - Ù†Ø³Ø®Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #EBF4FF 0%, #E0E7FF 100%); min-height: 100vh; padding: 1rem;}
        .container {max-width: 1400px; margin: 0 auto;}
        .header {background: linear-gradient(to left, #DC2626 0%, #B91C1C 100%); color: white; border-radius: 1rem 1rem 0 0; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.15);}
        .header-content {display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;}
        .header-title {display: flex; align-items: center; gap: 0.75rem;}
        .header h1 {font-size: 1.5rem; font-weight: bold;}
        .header p {color: #FEE2E2; font-size: 0.875rem; margin-top: 0.25rem;}
        .badge {background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;}
        .badge:hover {background: rgba(255,255,255,0.3);}
        .badge.success {background: rgba(16, 185, 129, 0.3);}
        .form-container {background: white; border-radius: 0 0 1rem 1rem; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);}
        .section {margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #E5E7EB;}
        .section:last-of-type {border-bottom: none;}
        .section-title {font-size: 1.125rem; font-weight: bold; color: #1F2937; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; justify-content: space-between;}
        .grid {display: grid; gap: 1rem; grid-template-columns: 1fr;}
        .grid-3 {display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));}
        @media (min-width: 768px) {.grid {grid-template-columns: repeat(2, 1fr);} .form-container {padding: 2.5rem;}}
        .form-group {display: flex; flex-direction: column;}
        label {font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;}
        input, textarea, select {padding: 0.75rem 1rem; border: 2px solid #D1D5DB; border-radius: 0.5rem; font-size: 1rem; transition: all 0.2s; font-family: inherit;}
        input:focus, textarea:focus, select:focus {outline: none; border-color: #6366F1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);}
        input:read-only {background: #F3F4F6;}
        textarea {resize: vertical; min-height: 100px;}
        .info-box {background: #F0F9FF; border: 2px solid #3B82F6; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;}
        .info-box.warning {background: #FEF3C7; border-color: #F59E0B;}
        .info-box.success {background: #D1FAE5; border-color: #10B981;}
        .info-box.purple {background: #F3E8FF; border-color: #A855F7;}
        .info-box h3 {font-size: 0.875rem; font-weight: bold; color: #1E40AF; margin-bottom: 0.5rem;}
        .info-box.warning h3 {color: #92400E;}
        .info-box.success h3 {color: #065F46;}
        .info-box.purple h3 {color: #7E22CE;}
        .info-table {width: 100%; border-collapse: collapse; font-size: 0.875rem;}
        .info-table td {padding: 0.5rem; border-bottom: 1px solid #BFDBFE;}
        .info-table td:first-child {font-weight: 600; color: #1E40AF; width: 40%;}
        .info-table tr:last-child td {border-bottom: none;}
        .stock-display {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem; margin-top: 1rem;}
        .stock-item {background: #F9FAFB; border: 2px solid #E5E7EB; border-radius: 0.5rem; padding: 1rem; transition: all 0.3s;}
        .stock-item-title {font-size: 0.75rem; color: #6B7280; margin-bottom: 0.5rem; font-weight: 600;}
        .stock-item-value {font-size: 1.5rem; font-weight: bold; color: #1F2937; margin: 0.5rem 0;}
        .stock-item-detail {font-size: 0.75rem; color: #9CA3AF; margin: 0.25rem 0;}
        .stock-item.low {background: #FEF2F2; border-color: #FCA5A5;}
        .stock-item.low .stock-item-value {color: #DC2626;}
        .stock-item.warning {background: #FEF3C7; border-color: #FCD34D;}
        .stock-item.warning .stock-item-value {color: #D97706;}
        .button-group {display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 2rem;}
        button {padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
        button:hover:not(:disabled) {transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15);}
        button:disabled {opacity: 0.6; cursor: not-allowed; transform: none;}
        .btn-primary {background: linear-gradient(to left, #6366F1 0%, #4F46E5 100%); color: white;}
        .btn-save {background: linear-gradient(to left, #10B981 0%, #059669 100%); color: white;}
        .btn-danger {background: linear-gradient(to left, #EF4444 0%, #DC2626 100%); color: white;}
        .btn-secondary {background: linear-gradient(to left, #8B5CF6 0%, #7C3AED 100%); color: white;}
        .btn-sm {padding: 0.5rem 1rem; font-size: 0.8rem;}
        .modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem;}
        .modal.show {display: flex;}
        .modal-content {background: white; border-radius: 1rem; padding: 2rem; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;}
        .modal-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #E5E7EB;}
        .modal-header h2 {font-size: 1.25rem; color: #1F2937;}
        .modal-close {background: #EF4444; color: white; border: none; border-radius: 0.375rem; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; font-weight: bold;}
        .material-item {background: #F9FAFB; border: 2px solid #E5E7EB; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;}
        .material-info {flex: 1;}
        .material-name {font-weight: bold; color: #1F2937; margin-bottom: 0.25rem;}
        .material-details {font-size: 0.875rem; color: #6B7280;}
        .material-actions {display: flex; gap: 0.5rem;}
        .alert {position: fixed; top: 2rem; left: 50%; transform: translateX(-50%) translateY(-100px); background: #10B981; color: white; padding: 1rem 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); opacity: 0; transition: all 0.3s; z-index: 1001; font-weight: bold;}
        .alert.show {transform: translateX(-50%) translateY(0); opacity: 1;}
        .alert.error {background: #EF4444;}
        
        .date-input-wrapper {position: relative;}
        .calendar-popup {position: absolute; top: 100%; left: 0; background: white; border: 2px solid #6366F1; border-radius: 0.75rem; padding: 1rem; margin-top: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 100; display: none; min-width: 320px;}
        .calendar-popup.show {display: block;}
        .calendar-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #E5E7EB;}
        .calendar-header button {padding: 0.5rem; background: linear-gradient(to left, #6366F1, #4F46E5); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1.2rem; min-width: 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .calendar-header button:hover {transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.15);}
        .calendar-month {font-weight: bold; color: #1F2937; font-size: 1rem;}
        .calendar-grid {display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;}
        .calendar-day {padding: 0.75rem; text-align: center; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; background: #F9FAFB; border: 1px solid #E5E7EB;}
        .calendar-day:hover {background: #EEF2FF; transform: scale(1.05);}
        .calendar-day.today {background: linear-gradient(135deg, #10B981, #059669); color: white; font-weight: bold;}
        .calendar-day.selected {background: linear-gradient(135deg, #6366F1, #4F46E5); color: white; font-weight: bold;}
        .calendar-day.disabled {color: #D1D5DB; cursor: not-allowed; background: #F3F4F6;}
        .calendar-day.disabled:hover {transform: none; background: #F3F4F6;}
        
        .stat-card {background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
        .stat-label {font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;}
        .stat-value {font-size: 2rem; font-weight: bold;}
    </style>
</head>
<body>
    <div class="alert" id="alert">Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚ âœ“</div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h2>
                <button class="modal-close" onclick="closeSettingsModal()">Ø¨Ø³ØªÙ†</button>
            </div>

            <div class="section">
                <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #1F2937;">ğŸŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±ÙˆØ±</h3>
                <div class="form-group">
                    <label>Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± JSON</label>
                    <input type="text" id="serverUrl" placeholder="https://api.npoint.io/YOUR_KEY">
                    <p style="font-size: 0.75rem; color: #6B7280; margin-top: 0.5rem;">
                        Ø¢Ø¯Ø±Ø³ npoint.io ÛŒØ§ GitHub JSON Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
                    </p>
                </div>
            </div>

            <div class="section">
                <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #1F2937;">ğŸ“¦ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø¨Ù†Ø§ÛŒ Ù…ÙˆØ§Ø¯ (ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡)</h3>
                <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">Ø§ÛŒÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                <div id="initialStockInputs" class="grid"></div>
            </div>

            <button class="btn-save" onclick="saveSettings()" style="width: 100%;">
                âœ“ Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
            </button>
        </div>
    </div>

    <!-- Materials Modal -->
    <div class="modal" id="materialsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“¦ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</h2>
                <button class="modal-close" onclick="closeMaterialsModal()">Ø¨Ø³ØªÙ†</button>
            </div>

            <button class="btn-primary btn-sm" onclick="showAddMaterialForm()" style="margin-bottom: 1rem; width: 100%;">
                â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯
            </button>

            <div id="addMaterialForm" style="display: none; background: #F0F9FF; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Ù…Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯</h3>
                <div class="grid">
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ù…Ø§Ø¯Ù‡</label>
                        <input type="text" id="newMaterialName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø³ÛŒÙ…Ø§Ù† Ù¾Ø±ØªÙ„Ù†Ø¯">
                    </div>
                    <div class="form-group">
                        <label>ÙˆØ§Ø­Ø¯</label>
                        <input type="text" id="newMaterialUnit" placeholder="Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù… / Ù„ÛŒØªØ± / ØªÙ†">
                    </div>
                    <div class="form-group">
                        <label>Ù…ØµØ±Ù Ø¯Ø± Ø±ÛŒÙ†Ú¯</label>
                        <input type="number" id="newMaterialConsumption" placeholder="0">
                    </div>
                </div>
                <div class="button-group" style="margin-top: 0.75rem;">
                    <button class="btn-save" onclick="addMaterial()">âœ“ Ø°Ø®ÛŒØ±Ù‡</button>
                    <button class="btn-danger" onclick="hideAddMaterialForm()">âœ• Ù„ØºÙˆ</button>
                </div>
            </div>

            <div id="materialsList"></div>
        </div>
    </div>

    <!-- Edit Material Modal -->
    <div class="modal" id="editMaterialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø§Ø¯Ù‡</h2>
                <button class="modal-close" onclick="closeEditMaterialModal()">Ø¨Ø³ØªÙ†</button>
            </div>
            <input type="hidden" id="editMaterialKey">
            <div class="grid">
                <div class="form-group">
                    <label>Ù†Ø§Ù… Ù…Ø§Ø¯Ù‡</label>
                    <input type="text" id="editMaterialName">
                </div>
                <div class="form-group">
                    <label>ÙˆØ§Ø­Ø¯</label>
                    <input type="text" id="editMaterialUnit">
                </div>
                <div class="form-group">
                    <label>Ù…ØµØ±Ù Ø¯Ø± Ø±ÛŒÙ†Ú¯</label>
                    <input type="number" id="editMaterialConsumption">
                </div>
            </div>
            <button class="btn-save" onclick="saveEditMaterial()" style="width: 100%; margin-top: 1rem;">
                âœ“ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
            </button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <div>
                        <h1>ğŸ­ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø³Ú¯Ù…Ù†Øª</h1>
                        <p>Ù¾Ø±ÙˆÚ˜Ù‡ Ø®Ø· Û±Û° Ù…ØªØ±Ùˆ ØªÙ‡Ø±Ø§Ù† - Ù†Ø³Ø®Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø®ÙˆØ¯Ú©Ø§Ø±</p>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <div class="badge success" onclick="openSettingsModal()">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
                    <div class="badge success">ğŸ¤– Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø®ÙˆØ¯Ú©Ø§Ø±</div>
                </div>
            </div>
        </div>

        <div class="form-container">
            <!-- Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹ -->
            <div class="grid-3" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">ğŸ“Š ØªÙˆÙ„ÛŒØ¯ ØªØ¬Ù…Ø¹ÛŒ</div>
                    <div class="stat-value" id="statCumulative">Û°</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #F093FB 0%, #F5576C 100%);">
                    <div class="stat-label">ğŸ“… ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø±ÙˆØ²</div>
                    <div class="stat-value" id="statToday">Û°</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stat-label">ğŸ¯ ØªÙˆÙ„ÛŒØ¯ Ù…Ø§Ù‡</div>
                    <div class="stat-value" id="statMonthly">Û°</div>
                </div>
            </div>

            <div class="info-box success">
                <h3>âœ“ Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡</h3>
                <p style="font-size: 0.875rem; color: #065F46;" id="lastSaveInfo">Ù‡Ù†ÙˆØ² Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡</p>
            </div>

            <!-- ØªØ§Ø±ÛŒØ® -->
            <div class="section">
                <h2 class="section-title">ğŸ“… ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´</h2>
                <div class="grid">
                    <div class="form-group">
                        <label>ØªØ§Ø±ÛŒØ®</label>
                        <div class="date-input-wrapper">
                            <input type="text" id="reportDate" value="1404/08/18" readonly style="cursor: pointer;">
                            <div class="calendar-popup" id="calendar">
                                <div class="calendar-header">
                                    <button onclick="changeMonth(-1); event.stopPropagation();">â—€</button>
                                    <span class="calendar-month" id="calendarMonth"></span>
                                    <button onclick="changeMonth(1); event.stopPropagation();">â–¶</button>
                                </div>
                                <div class="calendar-grid" id="calendarGrid"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ø±ÙˆØ²</label>
                        <input type="text" id="dayName" value="Ø´Ù†Ø¨Ù‡" readonly>
                    </div>
                </div>
            </div>

            <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ„ÛŒØ¯ -->
            <div class="section">
                <h2 class="section-title">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ„ÛŒØ¯</h2>
                <div class="info-box purple">
                    <h3>ğŸ¤– Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±</h3>
                    <p style="font-size: 0.875rem; color: #7E22CE;">
                        ØªÙˆÙ„ÛŒØ¯ ØªØ¬Ù…Ø¹ÛŒ Ùˆ Ù…ØµØ±Ù Ù…ÙˆØ§Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    </p>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø±ÙˆØ² (Ø±ÛŒÙ†Ú¯)</label>
                        <input type="number" id="ringsProduced" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø³Ø¨Ø¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡</label>
                        <input type="number" id="basketsProduced" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªÙˆÙ„ÛŒØ¯ Ù…Ø§Ù‡ (Ø±ÛŒÙ†Ú¯)</label>
                        <input type="number" id="monthlyProduction" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªÙˆÙ„ÛŒØ¯ Ø³Ø§Ù„ Û±Û´Û°Û´</label>
                        <input type="number" id="yearlyProduction" value="0">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>ØªÙˆÙ„ÛŒØ¯ ØªØ¬Ù…Ø¹ÛŒ Ú©Ù„ (Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±)</label>
                        <input type="number" id="totalProduction" value="0" readonly>
                    </div>
                </div>
            </div>

            <!-- ÙˆØ±ÙˆØ¯ÛŒ Ù…ÙˆØ§Ø¯ -->
            <div class="section">
                <h2 class="section-title">
                    <span>ğŸ“¥ ÙˆØ±ÙˆØ¯ÛŒ Ù…ÙˆØ§Ø¯ Ø§Ù…Ø±ÙˆØ²</span>
                    <button class="btn-secondary btn-sm" onclick="openMaterialsModal()">âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ§Ø¯</button>
                </h2>
                <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">
                    Ù…ÙˆØ§Ø¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ù…Ø±ÙˆØ² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¯Ø§Ø´ØªÙ† ÙˆØ±ÙˆØ¯ÛŒØŒ ØµÙØ± Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯)
                </p>
                <div class="grid" id="inputMaterials"></div>
            </div>

            <!-- Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ø§Øª -->
            <div class="section">
                <h2 class="section-title">ğŸ“¦ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</h2>
                
                <div id="materialRatesDisplay" class="info-box">
                    <h3>ğŸ“Œ Ù…ØµØ±Ù Ù…ÙˆØ§Ø¯ Ø¯Ø± Ù‡Ø± Ø±ÛŒÙ†Ú¯</h3>
                    <table class="info-table" id="ratesTable"></table>
                </div>

                <h3 style="margin-top: 1.5rem; margin-bottom: 0.75rem; font-size: 1rem; color: #1F2937;">ğŸ’¡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù…Ø±ÙˆØ²</h3>
                <div class="stock-display" id="stockDisplay"></div>
            </div>

            <!-- Ù…Ø´Ú©Ù„Ø§Øª -->
            <div class="section">
                <h2 class="section-title">âš ï¸ Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ù…ÙˆØ§Ù†Ø¹</h2>
                <textarea id="issues" placeholder="Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
            </div>

            <!-- Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª -->
            <div class="section">
                <h2 class="section-title">ğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª</h2>
                <textarea id="suggestions" placeholder="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
            </div>

            <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
            <div class="button-group">
                <button class="btn-save" onclick="saveData()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ</button>
                <button class="btn-primary" onclick="syncToServer()">â˜ï¸ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø³Ø±ÙˆØ±</button>
                <button class="btn-primary" onclick="syncFromServer()">ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø² Ø³Ø±ÙˆØ±</button>
                <button class="btn-primary" onclick="exportJSON()">ğŸ“¥ ØµØ§Ø¯Ø±Ø§Øª JSON</button>
                <button class="btn-primary" onclick="copyReport()">ğŸ“‹ Ú©Ù¾ÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
            </div>
        </div>
    </div>

    <script>
        let materials = {
            rebar8: {name: 'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Û¸', unit: 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', consumptionPerRing: 736, initialStock: 0, currentStock: 0},
            rebar12: {name: 'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Û±Û²', unit: 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', consumptionPerRing: 758, initialStock: 0, currentStock: 0},
            rebar20: {name: 'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Û²Û°', unit: 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', consumptionPerRing: 250, initialStock: 0, currentStock: 0},
            superplasticizer: {name: 'ÙÙˆÙ‚ Ø±ÙˆØ§Ù†â€ŒÚ©Ù†Ù†Ø¯Ù‡', unit: 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', consumptionPerRing: 45, initialStock: 0, currentStock: 0}
        };

        let materialInputs = {};
        let cumulativeProduction = 0;
        let currentCalendarYear = 1404;
        let currentCalendarMonth = 8;
        let selectedJalaaliDate = null;
        let history = [];

        const persianMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
        const persianDays = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡'];

        function toPersianNumber(num) {
            const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            return String(num).replace(/\d/g, x => persianDigits[x]);
        }

        function toEnglishNumber(str) {
            const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            const arabicDigits = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            let result = str;
            for (let i = 0; i < 10; i++) {
                result = result.replace(new RegExp(persianDigits[i], 'g'), i);
                result = result.replace(new RegExp(arabicDigits[i], 'g'), i);
            }
            return result;
        }

        function jalaaliToGregorian(jy, jm, jd) {
            const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            let gy = (jy <= 979) ? 621 : 1600;
            jy -= (jy <= 979) ? 0 : 979;
            let days = (365 * jy) + (Math.floor(jy / 33) * 8) + Math.floor(((jy % 33) + 3) / 4) + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
            gy += 400 * Math.floor(days / 146097);
            days %= 146097;
            let leap = true;
            if (days >= 36525) {
                days--;
                gy += 100 * Math.floor(days / 36524);
                days %= 36524;
                if (days >= 365) days++;
                else leap = false;
            }
            gy += 4 * Math.floor(days / 1461);
            days %= 1461;
            if (days >= 366) {
                leap = false;
                days--;
                gy += Math.floor(days / 365);
                days %= 365;
            }
            let gd = days + 1;
            let sal_a = [0, 31, ((leap && (gy % 4 === 0) && ((gy % 100 !== 0) || (gy % 400 === 0))) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            let gm;
            for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm];
            return [gy, gm, gd];
        }

        function gregorianToJalaali(gy, gm, gd) {
            const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            let jy = (gy <= 1600) ? 0 : 979;
            gy -= (gy <= 1600) ? 621 : 1600;
            let days = (365 * gy) + (Math.floor((gy + 3) / 4)) - (Math.floor((gy + 99) / 100)) + (Math.floor((gy + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
            if (gm > 2 && ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0))) days++;
            jy += 33 * Math.floor(days / 12053);
            days %= 12053;
            jy += 4 * Math.floor(days / 1461);
            days %= 1461;
            if (days > 365) {
                jy += Math.floor((days - 1) / 365);
                days = (days - 1) % 365;
            }
            let jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
            let jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
            return [jy, jm, jd];
        }

        function isLeapJalaaliYear(year) {
            return [1, 5, 9, 13, 17, 22, 26, 30].indexOf(year % 33) !== -1;
        }

        function getDaysInJalaaliMonth(year, month) {
            if (month <= 6) return 31;
            if (month <= 11) return 30;
            return isLeapJalaaliYear(year) ? 30 : 29;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthEl = document.getElementById('calendarMonth');
            
            monthEl.textContent = persianMonths[currentCalendarMonth - 1] + ' ' + toPersianNumber(currentCalendarYear);
            
            const daysInMonth = getDaysInJalaaliMonth(currentCalendarYear, currentCalendarMonth);
            const firstDayGregorian = jalaaliToGregorian(currentCalendarYear, currentCalendarMonth, 1);
            const firstDay = new Date(firstDayGregorian[0], firstDayGregorian[1] - 1, firstDayGregorian[2]);
            const firstDayOfWeek = (firstDay.getDay() + 1) % 7;
            
            let html = '';
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<div class="calendar-day disabled"></div>';
            }
            
            const today = new Date();
            const todayJalaali = gregorianToJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
            
            for (let day = 1; day <= daysInMonth; day++) {
                let classes = 'calendar-day';
                
                if (todayJalaali[0] === currentCalendarYear && todayJalaali[1] === currentCalendarMonth && todayJalaali[2] === day) {
                    classes += ' today';
                }
                
                if (selectedJalaaliDate && 
                    selectedJalaaliDate.year === currentCalendarYear && 
                    selectedJalaaliDate.month === currentCalendarMonth && 
                    selectedJalaaliDate.day === day) {
                    classes += ' selected';
                }
                
                html += `<div class="${classes}" onclick="selectDate(${day})">${toPersianNumber(day)}</div>`;
            }
            
            grid.innerHTML = html;
        }

        function changeMonth(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth > 12) {
                currentCalendarMonth = 1;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 1) {
                currentCalendarMonth = 12;
                currentCalendarYear--;
            }
            renderCalendar();
        }

        function selectDate(day) {
            selectedJalaaliDate = {
                year: currentCalendarYear,
                month: currentCalendarMonth,
                day: day
            };
            
            const dateStr = toPersianNumber(currentCalendarYear) + '/' + 
                          toPersianNumber(String(currentCalendarMonth).padStart(2, '0')) + '/' + 
                          toPersianNumber(String(day).padStart(2, '0'));
            
            document.getElementById('reportDate').value = dateStr;
            
            const gregorian = jalaaliToGregorian(currentCalendarYear, currentCalendarMonth, day);
            const gregorianDate = new Date(gregorian[0], gregorian[1] - 1, gregorian[2]);
            const dayOfWeek = gregorianDate.getDay();
            document.getElementById('dayName').value = persianDays[dayOfWeek];
            
            document.getElementById('calendar').classList.remove('show');
            renderCalendar();
        }

        document.getElementById('reportDate').addEventListener('click', function(e) {
            e.stopPropagation();
            const calendar = document.getElementById('calendar');
            calendar.classList.toggle('show');
            if (calendar.classList.contains('show')) {
                renderCalendar();
            }
        });

        document.addEventListener('click', function(e) {
            const calendar = document.getElementById('calendar');
            const dateInput = document.getElementById('reportDate');
            if (!calendar.contains(e.target) && e.target !== dateInput) {
                calendar.classList.remove('show');
            }
        });

        document.getElementById('calendar').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        function init() {
            loadData();
            const today = new Date();
            const jalaali = gregorianToJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
            currentCalendarYear = jalaali[0];
            currentCalendarMonth = jalaali[1];
            selectedJalaaliDate = {year: jalaali[0], month: jalaali[1], day: jalaali[2]};
            
            renderInitialStockInputs();
            renderInputMaterials();
            renderMaterialRates();
            calculateAll();
            updateStats();
            
            document.querySelectorAll('input').forEach(el => {
                el.addEventListener('input', () => {
                    calculateAll();
                    updateStats();
                });
            });
        }

        function renderInitialStockInputs() {
            const container = document.getElementById('initialStockInputs');
            let html = '';
            Object.entries(materials).forEach(([key, mat]) => {
                html += '<div class="form-group">';
                html += '<label>' + mat.name + ' (' + mat.unit + ')</label>';
                html += '<input type="number" id="initial_' + key + '" value="' + mat.initialStock + '" placeholder="Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡">';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function renderInputMaterials() {
            const container = document.getElementById('inputMaterials');
            let html = '';
            Object.entries(materials).forEach(([key, mat]) => {
                html += '<div class="form-group">';
                html += '<label>ÙˆØ±ÙˆØ¯ÛŒ ' + mat.name + ' (' + mat.unit + ')</label>';
                html += '<input type="number" id="input_' + key + '" value="' + (materialInputs[key] || 0) + '" placeholder="0">';
                html += '</div>';
            });
            container.innerHTML = html;
            
            Object.keys(materials).forEach(key => {
                const input = document.getElementById('input_' + key);
                if (input) {
                    input.addEventListener('input', () => {
                        materialInputs[key] = parseFloat(input.value) || 0;
                        calculateAll();
                    });
                }
            });
        }

        function renderMaterialRates() {
            const table = document.getElementById('ratesTable');
            let html = '';
            Object.entries(materials).forEach(([key, mat]) => {
                html += '<tr>';
                html += '<td>' + mat.name + '</td>';
                html += '<td>' + toPersianNumber(mat.consumptionPerRing) + ' ' + mat.unit + '</td>';
                html += '</tr>';
            });
            table.innerHTML = html;
        }

        function calculateAll() {
            const todayProduction = parseFloat(document.getElementById('ringsProduced').value) || 0;
            
            // Update cumulative production
            const prevCumulative = cumulativeProduction;
            cumulativeProduction = prevCumulative + todayProduction;
            document.getElementById('totalProduction').value = Math.round(cumulativeProduction);
            
            // Calculate for each material
            const display = document.getElementById('stockDisplay');
            let html = '';
            
            Object.entries(materials).forEach(([key, mat]) => {
                const input = parseFloat(document.getElementById('input_' + key).value) || 0;
                const consumption = todayProduction * mat.consumptionPerRing;
                const newStock = mat.currentStock - consumption + input;
                
                materials[key].currentStock = Math.max(0, newStock);
                
                const capacity = Math.floor(materials[key].currentStock / mat.consumptionPerRing);
                const status = capacity < 5 ? 'low' : capacity < 10 ? 'warning' : '';
                
                html += '<div class="stock-item ' + status + '">';
                html += '<div class="stock-item-title">' + mat.name + '</div>';
                html += '<div class="stock-item-value">' + toPersianNumber(Math.round(materials[key].currentStock)) + ' ' + mat.unit + '</div>';
                html += '<div class="stock-item-detail">Ù…ØµØ±Ù Ø§Ù…Ø±ÙˆØ²: ' + toPersianNumber(Math.round(consumption)) + ' ' + mat.unit + '</div>';
                html += '<div class="stock-item-detail">ÙˆØ±ÙˆØ¯ÛŒ Ø§Ù…Ø±ÙˆØ²: ' + toPersianNumber(Math.round(input)) + ' ' + mat.unit + '</div>';
                html += '<div class="stock-item-detail">Ø¸Ø±ÙÛŒØª: ' + toPersianNumber(capacity) + ' Ø±ÛŒÙ†Ú¯</div>';
                html += '</div>';
            });
            
            display.innerHTML = html;
        }

        function updateStats() {
            const today = parseFloat(document.getElementById('ringsProduced').value) || 0;
            const monthly = parseFloat(document.getElementById('monthlyProduction').value) || 0;
            
            document.getElementById('statToday').textContent = toPersianNumber(today);
            document.getElementById('statMonthly').textContent = toPersianNumber(monthly);
            document.getElementById('statCumulative').textContent = toPersianNumber(Math.round(cumulativeProduction));
        }

        function openSettingsModal() {
            const savedUrl = localStorage.getItem('serverUrl') || 'https://api.npoint.io/d6c1e9764fbc76fd651a';
            document.getElementById('serverUrl').value = savedUrl;
            
            Object.entries(materials).forEach(([key, mat]) => {
                const input = document.getElementById('initial_' + key);
                if (input) input.value = mat.initialStock;
            });
            
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function saveSettings() {
            const url = document.getElementById('serverUrl').value.trim();
            if (url) {
                localStorage.setItem('serverUrl', url);
            }
            
            Object.keys(materials).forEach(key => {
                const input = document.getElementById('initial_' + key);
                if (input) {
                    const value = parseFloat(input.value) || 0;
                    materials[key].initialStock = value;
                    materials[key].currentStock = value;
                }
            });
            
            calculateAll();
            showAlert('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
            closeSettingsModal();
        }

        function openMaterialsModal() {
            renderMaterialsList();
            document.getElementById('materialsModal').classList.add('show');
        }

        function closeMaterialsModal() {
            document.getElementById('materialsModal').classList.remove('show');
            hideAddMaterialForm();
        }

        function showAddMaterialForm() {
            document.getElementById('addMaterialForm').style.display = 'block';
        }

        function hideAddMaterialForm() {
            document.getElementById('addMaterialForm').style.display = 'none';
            document.getElementById('newMaterialName').value = '';
            document.getElementById('newMaterialUnit').value = '';
            document.getElementById('newMaterialConsumption').value = '';
        }

        function addMaterial() {
            const name = document.getElementById('newMaterialName').value.trim();
            const unit = document.getElementById('newMaterialUnit').value.trim();
            const consumption = parseFloat(document.getElementById('newMaterialConsumption').value) || 0;
            
            if (!name || !unit) {
                showAlert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ ÙˆØ§Ø­Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            const key = 'mat_' + Date.now();
            materials[key] = {
                name: name,
                unit: unit,
                consumptionPerRing: consumption,
                initialStock: 0,
                currentStock: 0
            };
            
            hideAddMaterialForm();
            renderMaterialsList();
            renderInitialStockInputs();
            renderInputMaterials();
            renderMaterialRates();
            calculateAll();
            showAlert('Ù…Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
        }

        function renderMaterialsList() {
            const container = document.getElementById('materialsList');
            let html = '';
            
            Object.entries(materials).forEach(([key, mat]) => {
                html += '<div class="material-item">';
                html += '<div class="material-info">';
                html += '<div class="material-name">' + mat.name + '</div>';
                html += '<div class="material-details">';
                html += 'ÙˆØ§Ø­Ø¯: ' + mat.unit + ' | ';
                html += 'Ù…ØµØ±Ù: ' + toPersianNumber(mat.consumptionPerRing) + ' Ø¯Ø± Ø±ÛŒÙ†Ú¯';
                html += '</div>';
                html += '</div>';
                html += '<div class="material-actions">';
                html += '<button class="btn-primary btn-sm" onclick="editMaterial(\'' + key + '\')">âœï¸</button>';
                html += '<button class="btn-danger btn-sm" onclick="deleteMaterial(\'' + key + '\')">ğŸ—‘ï¸</button>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function editMaterial(key) {
            const mat = materials[key];
            document.getElementById('editMaterialKey').value = key;
            document.getElementById('editMaterialName').value = mat.name;
            document.getElementById('editMaterialUnit').value = mat.unit;
            document.getElementById('editMaterialConsumption').value = mat.consumptionPerRing;
            document.getElementById('editMaterialModal').classList.add('show');
        }

        function closeEditMaterialModal() {
            document.getElementById('editMaterialModal').classList.remove('show');
        }

        function saveEditMaterial() {
            const key = document.getElementById('editMaterialKey').value;
            const name = document.getElementById('editMaterialName').value.trim();
            const unit = document.getElementById('editMaterialUnit').value.trim();
            const consumption = parseFloat(document.getElementById('editMaterialConsumption').value) || 0;
            
            if (!name || !unit) {
                showAlert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ ÙˆØ§Ø­Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            materials[key].name = name;
            materials[key].unit = unit;
            materials[key].consumptionPerRing = consumption;
            
            closeEditMaterialModal();
            renderMaterialsList();
            renderInitialStockInputs();
            renderInputMaterials();
            renderMaterialRates();
            calculateAll();
            showAlert('ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
        }

        function deleteMaterial(key) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø§Ø¯Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
            
            delete materials[key];
            delete materialInputs[key];
            
            renderMaterialsList();
            renderInitialStockInputs();
            renderInputMaterials();
            renderMaterialRates();
            calculateAll();
            showAlert('Ù…Ø§Ø¯Ù‡ Ø­Ø°Ù Ø´Ø¯', 'success');
        }

        function saveData() {
            const data = {
                version: '4.0',
                lastUpdate: new Date().toISOString(),
                date: document.getElementById('reportDate').value,
                dayName: document.getElementById('dayName').value,
                production: {
                    today: parseFloat(document.getElementById('ringsProduced').value) || 0,
                    baskets: parseFloat(document.getElementById('basketsProduced').value) || 0,
                    monthly: parseFloat(document.getElementById('monthlyProduction').value) || 0,
                    yearly: parseFloat(document.getElementById('yearlyProduction').value) || 0,
                    cumulative: cumulativeProduction
                },
                materials: materials,
                materialInputs: materialInputs,
                issues: document.getElementById('issues').value,
                suggestions: document.getElementById('suggestions').value,
                history: history,
                config: {
                    autoBackup: true,
                    maxHistory: 30
                }
            };
            
            localStorage.setItem('segmentData', JSON.stringify(data));
            document.getElementById('lastSaveInfo').textContent = 'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ø¯Ø± ' + new Date().toLocaleTimeString('fa-IR');
            showAlert('âœ“ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
        }

        function loadData() {
            const saved = localStorage.getItem('segmentData');
            if (!saved) return;
            
            try {
                const data = JSON.parse(saved);
                
                if (data.date) document.getElementById('reportDate').value = data.date;
                if (data.dayName) document.getElementById('dayName').value = data.dayName;
                
                if (data.production) {
                    document.getElementById('ringsProduced').value = data.production.today || 0;
                    document.getElementById('basketsProduced').value = data.production.baskets || 0;
                    document.getElementById('monthlyProduction').value = data.production.monthly || 0;
                    document.getElementById('yearlyProduction').value = data.production.yearly || 0;
                    cumulativeProduction = data.production.cumulative || 0;
                    document.getElementById('totalProduction').value = Math.round(cumulativeProduction);
                }
                
                if (data.materials) materials = data.materials;
                if (data.materialInputs) materialInputs = data.materialInputs;
                if (data.history) history = data.history;
                if (data.issues) document.getElementById('issues').value = data.issues;
                if (data.suggestions) document.getElementById('suggestions').value = data.suggestions;
                
                if (data.lastUpdate) {
                    document.getElementById('lastSaveInfo').textContent = 
                        'Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡: ' + new Date(data.lastUpdate).toLocaleTimeString('fa-IR');
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        async function syncToServer() {
            const serverUrl = localStorage.getItem('serverUrl') || 'https://api.npoint.io/d6c1e9764fbc76fd651a';
            
            const data = {
                version: '4.0',
                lastUpdate: new Date().toISOString(),
                date: document.getElementById('reportDate').value,
                dayName: document.getElementById('dayName').value,
                production: {
                    today: parseFloat(document.getElementById('ringsProduced').value) || 0,
                    baskets: parseFloat(document.getElementById('basketsProduced').value) || 0,
                    monthly: parseFloat(document.getElementById('monthlyProduction').value) || 0,
                    yearly: parseFloat(document.getElementById('yearlyProduction').value) || 0,
                    cumulative: cumulativeProduction
                },
                materials: materials,
                materialInputs: materialInputs,
                issues: document.getElementById('issues').value,
                suggestions: document.getElementById('suggestions').value,
                history: history.slice(-30),
                config: {
                    autoBackup: true,
                    maxHistory: 30
                }
            };
            
            try {
                const response = await fetch(serverUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('âœ“ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø³Ø±ÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                    saveData();
                } else {
                    showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±', 'error');
                }
            } catch (error) {
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±', 'error');
                console.error('Sync error:', error);
            }
        }

        async function syncFromServer() {
            const serverUrl = localStorage.getItem('serverUrl') || 'https://api.npoint.io/d6c1e9764fbc76fd651a';
            
            try {
                const response = await fetch(serverUrl);
                if (!response.ok) throw new Error('Server error');
                
                const data = await response.json();
                
                if (data.date) document.getElementById('reportDate').value = data.date;
                if (data.dayName) document.getElementById('dayName').value = data.dayName;
                
                if (data.production) {
                    document.getElementById('ringsProduced').value = data.production.today || 0;
                    document.getElementById('basketsProduced').value = data.production.baskets || 0;
                    document.getElementById('monthlyProduction').value = data.production.monthly || 0;
                    document.getElementById('yearlyProduction').value = data.production.yearly || 0;
                    cumulativeProduction = data.production.cumulative || 0;
                    document.getElementById('totalProduction').value = Math.round(cumulativeProduction);
                }
                
                if (data.materials) {
                    materials = data.materials;
                    renderInitialStockInputs();
                    renderInputMaterials();
                    renderMaterialRates();
                }
                
                if (data.materialInputs) {
                    materialInputs = data.materialInputs;
                    Object.entries(materialInputs).forEach(([key, value]) => {
                        const input = document.getElementById('input_' + key);
                        if (input) input.value = value;
                    });
                }
                
                if (data.history) history = data.history;
                if (data.issues) document.getElementById('issues').value = data.issues;
                if (data.suggestions) document.getElementById('suggestions').value = data.suggestions;
                
                calculateAll();
                updateStats();
                saveData();
                
                showAlert('âœ“ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success');
            } catch (error) {
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ø³Ø±ÙˆØ±', 'error');
                console.error('Sync error:', error);
            }
        }

        function exportJSON() {
            const data = {
                version: '4.0',
                exportDate: new Date().toISOString(),
                date: document.getElementById('reportDate').value,
                dayName: document.getElementById('dayName').value,
                production: {
                    today: parseFloat(document.getElementById('ringsProduced').value) || 0,
                    baskets: parseFloat(document.getElementById('basketsProduced').value) || 0,
                    monthly: parseFloat(document.getElementById('monthlyProduction').value) || 0,
                    yearly: parseFloat(document.getElementById('yearlyProduction').value) || 0,
                    cumulative: cumulativeProduction
                },
                materials: materials,
                materialInputs: materialInputs,
                issues: document.getElementById('issues').value,
                suggestions: document.getElementById('suggestions').value,
                history: history
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'segment-advanced-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            showAlert('âœ“ ÙØ§ÛŒÙ„ JSON Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
        }

        function copyReport() {
            const date = document.getElementById('reportDate').value;
            const day = document.getElementById('dayName').value;
            const today = parseFloat(document.getElementById('ringsProduced').value) || 0;
            const cumulative = Math.round(cumulativeProduction);
            const issues = document.getElementById('issues').value || 'Ø¨Ø¯ÙˆÙ† Ù…Ø´Ú©Ù„';
            const suggestions = document.getElementById('suggestions').value || 'Ø¨Ø¯ÙˆÙ† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯';
            
            let report = 'ğŸ­ Ú¯Ø²Ø§Ø±Ø´ Ø³ÛŒØ³ØªÙ… ØªÙˆÙ„ÛŒØ¯ Ø³Ú¯Ù…Ù†Øª\n';
            report += 'Ù¾Ø±ÙˆÚ˜Ù‡ Ø®Ø· Û±Û° Ù…ØªØ±Ùˆ ØªÙ‡Ø±Ø§Ù†\n';
            report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            report += 'ğŸ“… ØªØ§Ø±ÛŒØ®: ' + date + ' (' + day + ')\n\n';
            report += 'ğŸ“Š ØªÙˆÙ„ÛŒØ¯:\n';
            report += 'â–«ï¸ ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø±ÙˆØ²: ' + toPersianNumber(today) + ' Ø±ÛŒÙ†Ú¯\n';
            report += 'â–«ï¸ ØªÙˆÙ„ÛŒØ¯ ØªØ¬Ù…Ø¹ÛŒ: ' + toPersianNumber(cumulative) + ' Ø±ÛŒÙ†Ú¯\n\n';
            report += 'ğŸ“¦ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ù…ØµØ±Ù Ù…ÙˆØ§Ø¯:\n';
            
            Object.entries(materials).forEach(([key, mat]) => {
                const input = materialInputs[key] || 0;
                const consumption = today * mat.consumptionPerRing;
                const capacity = Math.floor(mat.currentStock / mat.consumptionPerRing);
                
                report += 'â–«ï¸ ' + mat.name + ':\n';
                report += '   â€¢ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ: ' + toPersianNumber(Math.round(mat.currentStock)) + ' ' + mat.unit + '\n';
                report += '   â€¢ Ù…ØµØ±Ù Ø§Ù…Ø±ÙˆØ²: ' + toPersianNumber(Math.round(consumption)) + ' ' + mat.unit + '\n';
                report += '   â€¢ ÙˆØ±ÙˆØ¯ÛŒ Ø§Ù…Ø±ÙˆØ²: ' + toPersianNumber(Math.round(input)) + ' ' + mat.unit + '\n';
                report += '   â€¢ Ø¸Ø±ÙÛŒØª Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡: ' + toPersianNumber(capacity) + ' Ø±ÛŒÙ†Ú¯\n\n';
            });
            
            report += 'âš ï¸ Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ù…ÙˆØ§Ù†Ø¹:\n' + issues + '\n\n';
            report += 'ğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª:\n' + suggestions + '\n';
            
            navigator.clipboard.writeText(report).then(() => {
                showAlert('âœ“ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
            });
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert ' + type;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        document.addEventListener('click', function(e) {
            const modals = ['settingsModal', 'materialsModal', 'editMaterialModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
